From d5fdd3bad3f20fc406b3ba69121201d84d2b8ed9 Mon Sep 17 00:00:00 2001
From: Alejandro del Castillo <alejandro.delcastillo@ni.com>
Date: Fri, 31 Aug 2018 17:25:44 +0300
Subject: [PATCH] libsolv_solver_execute_transaction: abort transaction on
 first failure

If package A depends on B, and B is corrupted, if you install A, opkg
will try to install B, fail and continue installing A. Change logic to
abort the transaction on first failure. This is consistent with the
internal solver behavior.

Signed-off-by: Alejandro del Castillo <alejandro.delcastillo@ni.com>
---
 libopkg/solvers/libsolv/opkg_solver_libsolv.c | 21 ++++++++++++++-----
 1 file changed, 16 insertions(+), 5 deletions(-)

diff --git a/libopkg/solvers/libsolv/opkg_solver_libsolv.c b/libopkg/solvers/libsolv/opkg_solver_libsolv.c
index 0593e9d..5a04682 100644
--- a/libopkg/solvers/libsolv/opkg_solver_libsolv.c
+++ b/libopkg/solvers/libsolv/opkg_solver_libsolv.c
@@ -894,14 +894,20 @@ static int libsolv_solver_execute_transaction(libsolv_solver_t *libsolv_solver)
             switch (typeId) {
             case SOLVER_TRANSACTION_ERASE:
                 ret = opkg_remove_pkg(pkg);
+                if (ret) {
+                    err = -1;
+                    goto CLEANUP;
+                }
                 break;
             case SOLVER_TRANSACTION_OBSOLETES:
                 /* Replaces operations are expressed in two steps: the first one is a SOLVER_TRANSACTION_OBSOLETES, with the name of
                  * the replacer package. The second one is a SOLVER_TRANSACTION_IGNORE, with the name of the replacee */
                 obs = pkgs->pkgs[i + 1];
                 ret = opkg_remove_pkg(obs);
-                if (ret)
-                    break;
+                if (ret) {
+                    err = -1;
+                    goto CLEANUP;
+                }
             case SOLVER_TRANSACTION_DOWNGRADE:
             case SOLVER_TRANSACTION_REINSTALL:
             case SOLVER_TRANSACTION_INSTALL:
@@ -923,6 +929,10 @@ static int libsolv_solver_execute_transaction(libsolv_solver_t *libsolv_solver)
                                  pkg->name, pkg->version, pkg->dest->name);
                 }
                 ret = opkg_install_pkg(pkg);
+                if (ret) {
+                    err = -1;
+                    goto CLEANUP;
+                }
                 break;
             case SOLVER_TRANSACTION_UPGRADE:
                 old = pkg_hash_fetch_installed_by_name(pkg->name);
@@ -951,14 +961,15 @@ static int libsolv_solver_execute_transaction(libsolv_solver_t *libsolv_solver)
                 }
 
                 ret = opkg_install_pkg(pkg);
+                if (ret) {
+                    err = -1;
+                    goto CLEANUP;
+                }
                 break;
             case SOLVER_TRANSACTION_IGNORE:
             default:
-                ret = 0;
                 break;
             }
-            if (ret)
-                err = -1;
         }
     }
 
-- 
2.18.0

